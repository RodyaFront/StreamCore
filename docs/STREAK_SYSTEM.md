# Streak-система (Retention-механика)

## Описание

Streak-система отслеживает последовательные посещения стримов пользователями и начисляет бонусы за регулярность. Это retention-механика, которая мотивирует зрителей возвращаться на стримы.

## Как работает

### Отслеживание посещений

- При первом сообщении пользователя на стриме автоматически отмечается посещение
- Посещение привязывается к дате стрима (не времени)
- Одно посещение на стрим (даже если пользователь написал много сообщений)

### Расчет streak

- Streak = количество последовательных календарных дней, когда пользователь был на стриме
- Начинается с даты текущего стрима и идет назад
- Если есть пропуск дня - streak обрывается
- Максимальный проверяемый streak: 10 дней

### Начисление бонусов

- **Минимальный streak**: 3 стрима подряд
- **Бонус**: 15 XP
- **Условие**: Бонус начисляется только когда streak достигает кратного 3 (3, 6, 9, 12, и т.д.)
- **Примеры**:
  - 3 стрима подряд → +15 XP
  - 6 стримов подряд → +15 XP
  - 9 стримов подряд → +15 XP

## База данных

### Таблица `stream_visits`

```sql
CREATE TABLE stream_visits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    stream_date DATE NOT NULL,
    first_message_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (username) REFERENCES user_stats(username) ON DELETE CASCADE,
    UNIQUE(username, stream_date)
);
```

**Индексы**:
- `idx_stream_visits_username` - для быстрого поиска по пользователю
- `idx_stream_visits_stream_date` - для сортировки по дате
- `idx_stream_visits_username_date` - составной индекс для оптимизации запросов

## Конфигурация

Константы в `src/backend/services/bonuses/constants.js`:

```javascript
export const STREAK_BONUS = {
    MIN_STREAK: 3,      // Минимальный streak для бонуса
    AMOUNT: 15,         // Количество опыта за бонус
    SOURCE: 'streak'    // Источник опыта
};
```

## Компоненты системы

### StreakService (`src/backend/services/bonuses/StreakService.js`)

- Отслеживает текущий стрим (дата)
- Отмечает посещения пользователей
- Рассчитывает streak для пользователя
- Сбрасывает состояние при начале/окончании стрима

**Методы**:
- `markVisit(username)` - отмечает посещение пользователя
- `getCurrentStreak(username)` - получает текущий streak
- `getStreakForStream(username, streamDate)` - получает streak для конкретной даты стрима

### StreakBonusHandler (`src/backend/services/bonuses/StreakBonusHandler.js`)

- Подписывается на события `message:logged`
- Отмечает посещение при первом сообщении
- Проверяет streak и начисляет бонус при достижении кратного 3

## События

### `streak:bonus:awarded`

Эмитится при начислении бонуса за streak:

```javascript
{
    username: string,
    streak: number,
    amount: number
}
```

## Примеры работы

### Пример 1: Первый streak

1. День 1: Пользователь написал сообщение → streak = 1
2. День 2: Пользователь написал сообщение → streak = 2
3. День 3: Пользователь написал сообщение → streak = 3 → **+15 XP бонус**

### Пример 2: Продолжение streak

4. День 4: Пользователь написал сообщение → streak = 4
5. День 5: Пользователь написал сообщение → streak = 5
6. День 6: Пользователь написал сообщение → streak = 6 → **+15 XP бонус**

### Пример 3: Обрыв streak

1. День 1-3: Пользователь был на стримах → streak = 3 → бонус
2. День 4: Пользователь НЕ был на стриме → streak обрывается
3. День 5: Пользователь снова на стриме → streak = 1 (начинается заново)

## Особенности

1. **Одно посещение на стрим**: Даже если пользователь написал много сообщений, посещение отмечается только один раз
2. **Привязка к дате**: Streak считается по календарным дням, а не по стримам
3. **Автоматический сброс**: При пропуске дня streak обрывается
4. **Бонус только за кратные 3**: Начисляется только при достижении 3, 6, 9, 12 и т.д.

## Будущие улучшения

- Учет времени между стримами (не только календарные дни)
- Разные бонусы за разные уровни streak
- Визуальное отображение streak в чате
- Статистика streak для пользователей
- Уведомления о приближении к новому уровню streak
