# Как начисляется опыт за streak

## Обзор

Streak-система применяет **постоянный множитель опыта** на весь стрим для пользователей с активным streak. Это retention-механика, которая мотивирует зрителей возвращаться на стримы и получать больше опыта за каждое сообщение.

## Механика начисления опыта

### Условия применения множителя

1. **Минимальный streak**: 3 стрима подряд
2. **Множитель**: 1.5x (50% бонус к опыту)
3. **Действие**: На весь стрим, за каждое сообщение

### Процесс начисления

```
1. Пользователь пишет сообщение на стриме
   ↓
2. Система рассчитывает базовый опыт (1-5 XP в зависимости от длины сообщения)
   ↓
3. Система проверяет streak пользователя для текущего стрима
   ↓
4. Если streak >= 3 → применяется множитель 1.5x
   ↓
5. Опыт умножается и добавляется через addExp()
```

## Примеры начисления

### Пример 1: Пользователь без streak

**Сценарий**:
- Пользователь пишет сообщение длиной 50 символов
- Базовый опыт: 3 XP
- Streak: 2 (меньше минимума)
- **Результат**: 3 XP (множитель не применяется)

### Пример 2: Пользователь с streak = 3

**Сценарий**:
- Пользователь пишет сообщение длиной 50 символов
- Базовый опыт: 3 XP
- Streak: 3 (достигнут минимум)
- Множитель: 1.5x
- **Результат**: 3 × 1.5 = 4.5 → округляется до 4 XP

**На стриме**:
- Сообщение 1 (10 символов): 1 × 1.5 = 1.5 → 1 XP
- Сообщение 2 (30 символов): 2 × 1.5 = 3 XP
- Сообщение 3 (50 символов): 3 × 1.5 = 4.5 → 4 XP
- Сообщение 4 (100 символов): 4 × 1.5 = 6 XP
- Сообщение 5 (150 символов): 5 × 1.5 = 7.5 → 7 XP

**Итого за стрим**: 21 XP (вместо 15 XP без множителя)

### Пример 3: Пользователь с streak = 5

**Сценарий**:
- Пользователь пишет сообщение длиной 100 символов
- Базовый опыт: 4 XP
- Streak: 5
- Множитель: 1.5x (не зависит от уровня streak)
- **Результат**: 4 × 1.5 = 6 XP

**Важно**: Множитель одинаковый для всех уровней streak >= 3 (3, 4, 5, 6...)

### Пример 4: Обрыв streak

**Сценарий**:
- День 1-5: Пользователь был → streak = 5 → множитель применялся
- День 6: Пользователь НЕ был на стриме → streak обрывается
- День 7: Пользователь снова на стриме → streak = 1 (начинается заново)
- **Результат**: Множитель не применяется до достижения streak = 3

## Технические детали

### Когда применяется множитель

Множитель применяется **при каждом сообщении** на стриме:
- Событие: `message:logged`
- Условие: `isCommand === false` (не команда)
- Условие: Стрим онлайн
- Условие: Streak >= MIN_STREAK (3)

### Расчет базового опыта

Базовый опыт рассчитывается по длине сообщения:

| Длина сообщения | Базовый опыт |
|----------------|--------------|
| 1-9 символов   | 1 XP         |
| 10-29 символов | 2 XP         |
| 30-49 символов | 3 XP         |
| 50-99 символов | 4 XP         |
| 100+ символов  | 5 XP         |

### Применение множителя

```javascript
// Псевдокод
function calculateExpWithStreak(username, messageLength) {
    baseExp = calculateMessageExp(messageLength); // 1-5 XP
    streak = getCurrentStreak(username);

    if (streak >= STREAK_BONUS.MIN_STREAK) {
        exp = Math.floor(baseExp * STREAK_BONUS.MULTIPLIER);
    } else {
        exp = baseExp;
    }

    return exp;
}
```

**Важно**: Результат округляется вниз (`Math.floor`) для целых чисел.

### Расчет streak

Streak рассчитывается как **последовательные стримы** (не календарные дни):
- Если пользователь был на стриме в день 1, 2, 3 → streak = 3
- Если пользователь был на стриме в день 1, 3 (пропустил день 2) → streak = 1

**Важно**: Streak считается по датам стримов, а не по календарным дням. Если стрима не было в какой-то день, это не обрывает streak.

### Отметка посещений

- Посещение отмечается только **один раз на стрим** (при первом сообщении)
- Даже если пользователь написал много сообщений, посещение отмечается только при первом
- Используется `Set` для отслеживания уже отмеченных пользователей в рамках текущего стрима
- В БД используется `UNIQUE(username, stream_date)` для защиты от дубликатов

## Конфигурация

### Константы (`constants.js`)

```javascript
export const STREAK_BONUS = {
    MIN_STREAK: 3,        // Минимальный streak для применения множителя
    MULTIPLIER: 1.5,     // Множитель опыта (1.5 = +50%)
    SOURCE: 'streak'     // Источник опыта (для логирования)
};
```

### Изменение настроек

Чтобы изменить множитель или минимальный streak, отредактируйте `constants.js`:

```javascript
export const STREAK_BONUS = {
    MIN_STREAK: 5,        // Изменить минимальный streak на 5
    MULTIPLIER: 2.0,     // Изменить множитель на 2.0x (+100%)
    SOURCE: 'streak'
};
```

## Сравнение: Старая vs Новая система

### Старая система (фиксированный бонус)

- Бонус: 15 XP один раз при первом сообщении на стриме
- При streak 3, 4, 5... → всегда 15 XP
- Не зависит от активности пользователя на стриме

**Пример**: Пользователь с streak = 5 пишет 10 сообщений
- Бонус: +15 XP (один раз)
- Опыт за сообщения: 30 XP (10 сообщений × 3 XP в среднем)
- **Итого**: 45 XP

### Новая система (множитель)

- Множитель: 1.5x к опыту за каждое сообщение
- При streak 3, 4, 5... → множитель применяется ко всем сообщениям
- Зависит от активности пользователя на стриме

**Пример**: Пользователь с streak = 5 пишет 10 сообщений
- Бонус: нет (множитель вместо бонуса)
- Опыт за сообщения: 30 × 1.5 = 45 XP (10 сообщений × 3 XP × 1.5)
- **Итого**: 45 XP

**Преимущества новой системы**:
- Мотивирует писать больше сообщений на стриме
- Справедливее: больше активности = больше опыта
- Постоянный бонус на весь стрим, а не одноразовый

## Важные моменты

### 1. Множитель на весь стрим

Множитель применяется **ко всем сообщениям** на стриме, пока streak >= MIN_STREAK.

### 2. Последовательность важна

Streak обрывается, если пользователь пропустил стрим. Нельзя "наверстать" пропущенный день.

### 3. Независимость от других бонусов

Streak-множитель применяется **независимо** от других бонусов:
- Можно получить и бонус за первое сообщение, и множитель за streak
- Опыт суммируется

### 4. Округление

Результат умножения округляется вниз (`Math.floor`), чтобы избежать дробных значений опыта.

### 5. Источник опыта

Опыт за сообщения с множителем имеет источник `'message'`, а не `'streak'`. Множитель применяется к базовому опыту, но источник остается `'message'`.

## Пример полного цикла

### Неделя активности пользователя

| День | Был на стриме | Streak | Сообщений | Базовый XP | С множителем | Итого XP |
|------|---------------|--------|-----------|------------|--------------|----------|
| 1    | ✅            | 1      | 10        | 30         | 30           | 30       |
| 2    | ✅            | 2      | 10        | 30         | 30           | 60       |
| 3    | ✅            | 3      | 10        | 30         | 45           | 105      |
| 4    | ✅            | 4      | 10        | 30         | 45           | 150      |
| 5    | ❌            | 0      | 0         | 0          | 0            | 150      |
| 6    | ✅            | 1      | 10        | 30         | 30           | 180      |
| 7    | ✅            | 2      | 10        | 30         | 30           | 210      |

**Итого за неделю**: 210 XP
- Без множителя: 180 XP
- Бонус от множителя: +30 XP

## Визуализация

```
Streak = 1  →  Сообщение: 3 XP → 3 XP (множитель не применяется)
Streak = 2  →  Сообщение: 3 XP → 3 XP (множитель не применяется)
Streak = 3  →  Сообщение: 3 XP → 4 XP (×1.5, округлено вниз)
Streak = 4  →  Сообщение: 3 XP → 4 XP (×1.5, округлено вниз)
Streak = 5  →  Сообщение: 3 XP → 4 XP (×1.5, округлено вниз)
```

**Важно**: Множитель одинаковый для всех уровней streak >= 3.
