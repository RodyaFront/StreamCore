# Миграции базы данных

## Описание

Система миграций автоматически применяется при запуске сервера и добавляет недостающие индексы и constraints к существующей базе данных.

## Примененные миграции

### Критичные индексы (применены автоматически)

1. **Составной индекс `idx_messages_username_timestamp`**
   - Таблица: `messages`
   - Поля: `(username, timestamp DESC)`
   - Назначение: Ускорение запросов истории сообщений пользователя

2. **Составной индекс `idx_redemptions_username_redeemed`**
   - Таблица: `redemptions`
   - Поля: `(username, redeemed_at DESC)`
   - Назначение: Ускорение запросов истории наград пользователя

3. **Индекс `idx_user_stats_message_count`**
   - Таблица: `user_stats`
   - Поля: `message_count DESC`
   - Назначение: Ускорение запросов топов пользователей

4. **Индекс `idx_user_stats_last_seen`**
   - Таблица: `user_stats`
   - Поля: `last_seen DESC`
   - Назначение: Ускорение запросов активных пользователей

5. **Индекс `idx_user_stats_first_seen`**
   - Таблица: `user_stats`
   - Поля: `first_seen`
   - Назначение: Ускорение запросов новичков

6. **Индекс `idx_rewards_redemption_count`**
   - Таблица: `rewards`
   - Поля: `redemption_count DESC`
   - Назначение: Ускорение запросов топов наград

7. **Индекс `idx_rewards_enabled`**
   - Таблица: `rewards`
   - Поля: `enabled`
   - Назначение: Ускорение фильтрации активных наград

8. **Индекс `idx_messages_is_command`**
   - Таблица: `messages`
   - Поля: `is_command`
   - Назначение: Ускорение фильтрации команд

### Очистка данных

9. **Очистка висячих записей**
   - Удаление записей из `redemptions`, у которых нет соответствующего пользователя в `user_stats`
   - Применяется автоматически при запуске

## Как это работает

1. При инициализации сервиса базы данных вызывается `runMigrations()`
2. Каждая миграция проверяет свое состояние через функцию `check()`
3. Если миграция не применена, выполняется функция `execute()`
4. Результаты логируются в консоль

## Добавление новых миграций

Для добавления новой миграции добавьте объект в массив `migrations` в файле `src/backend/database/migrations.js`:

```javascript
{
    name: 'Описание миграции',
    check: () => {
        // Проверка, применена ли миграция
        // Возвращает true, если миграция уже применена
        const result = db.prepare('...').get();
        return result !== null;
    },
    execute: () => {
        // Выполнение миграции
        db.exec('...');
    }
}
```

## Ручной запуск миграций

Миграции применяются автоматически при запуске сервера. Для ручного запуска можно использовать:

```javascript
import { runMigrations } from './database/migrations.js';
runMigrations();
```

## Откат миграций

SQLite не поддерживает автоматический откат миграций. Для отката нужно вручную удалить индексы:

```sql
DROP INDEX IF EXISTS idx_name;
```

## Проверка состояния мидексов

Для проверки всех индексов в базе данных:

```sql
SELECT name, tbl_name, sql
FROM sqlite_master
WHERE type='index' AND name NOT LIKE 'sqlite_%'
ORDER BY tbl_name, name;
```

