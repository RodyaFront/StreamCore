# Описание функционала StreamCore

## Обзор

StreamCore — это модульная платформа для создания стриминговых виджетов и приложений для Twitch. Платформа предоставляет комплексную систему для обработки чата, управления уровнями пользователей, обработки наград, отображения алертов и интерактивных виджетов.

## Архитектура

### Ядро платформы

Платформа построена на модульной архитектуре с использованием Event Bus для коммуникации между компонентами:

- **Event Bus** (`src/backend/core/events.js`) — централизованная система событий
- **Service Manager** (`src/backend/core/services.js`) — управление жизненным циклом сервисов
- **Plugin Manager** (`src/backend/core/plugins.js`) — автоматическая загрузка и инициализация плагинов
- **Logger** (`src/backend/core/logger.js`) — структурированное логирование

### Сервисы

#### HTTP Server (`src/backend/services/http/`)
- REST API для получения статистики чата
- Endpoints для работы с пользователями, сообщениями, уровнями
- Статическая раздача фронтенда

#### Socket.IO Server (`src/backend/services/socketio/`)
- Реал-тайм коммуникация между backend и frontend
- Трансляция событий: сообщения чата, уровни, алерты, обновления стрима
- Поддержка множественных подключений

#### Database Service (`src/backend/services/database/`)
- SQLite база данных (`data/chat_database.db`)
- Автоматическое создание схемы при первом запуске
- Миграции и индексы для оптимизации запросов

#### Twitch Service (`src/backend/services/twitch/`)
- **IRC Client** (`irc.js`) — подключение к Twitch IRC для получения сообщений чата
- **EventSub** (`eventsub.js`) — подписки на события Twitch (стрим онлайн/оффлайн, награды)
- **Token Refresh** (`token-refresh.js`) — автоматическое обновление OAuth токенов
- **Profanity Filter** (`profanity-filter.js`) — фильтрация нецензурной лексики

#### Stream Session Service (`src/backend/services/stream/`)
- Отслеживание статуса стрима (онлайн/оффлайн)
- Мониторинг количества зрителей
- Периодическая проверка статуса через Twitch API

## Система чата

### Обработка сообщений

**ChatMessageService** (`src/backend/services/chat/ChatMessageService.js`):
- Нормализация данных сообщений из IRC
- Валидация входных данных
- Парсинг эмодзи через EmoteService
- Генерация уникальных ID для сообщений
- Асинхронное обогащение информацией о подписке

**ChatEventHandler** (`src/backend/services/chat/ChatEventHandler.js`):
- Подписка на события IRC
- Перенаправление сообщений в ChatMessageService

**Логирование** (`src/backend/services/chat/logger.js`):
- Сохранение всех сообщений в БД
- Обновление статистики пользователей
- Подсчет количества сообщений и символов
- Отслеживание первого и последнего появления

**Статистика** (`src/backend/services/chat/stats.js`):
- Анализ любимых слов пользователей
- Периодическое обновление статистики
- Подсчет частоты использования слов

**UserInfoService** (`src/backend/services/chat/UserInfoService.js`):
- Получение уровня пользователя из БД
- Проверка первого сообщения пользователя
- Проверка статуса подписки через Twitch API

**EmoteService** (`src/backend/services/chat/EmoteService.js`):
- Парсинг Twitch эмодзи в HTML
- Поддержка кастомных эмодзи канала

**RateLimiter** (`src/backend/services/chat/RateLimiter.js`):
- Защита от спама и злоупотреблений
- Ограничение частоты сообщений

## Система уровней

### Механика прогрессии

**Формула опыта**:
- Базовый опыт за уровень: `EXP = 100 * N * (N + 1) / 2`
- Где N — текущий уровень
- Пример: уровень 1 = 100 опыта, уровень 2 = 300 опыта, уровень 3 = 600 опыта

**Расчет уровня**:
- Решение квадратного уравнения на основе общего опыта
- Автоматический расчет текущего опыта в рамках уровня
- Расчет опыта до следующего уровня

### Источники опыта

1. **Сообщения в чате** (`calculateMessageExp`):
   - Длина < 10 символов: 1 XP
   - Длина < 30 символов: 2 XP
   - Длина < 50 символов: 3 XP
   - Длина < 100 символов: 4 XP
   - Длина ≥ 100 символов: 5 XP
   - Команды (начинающиеся с `!`) не дают опыт

2. **Награды Channel Points**:
   - Опыт = стоимость награды в баллах
   - Начисляется автоматически при активации награды

3. **Бонусы**:
   - **Первое сообщение на стриме**: фиксированный бонус (настраивается в `constants.js`)
   - Сбрасывается при начале нового стрима

### Обработка опыта

**Функция `addExp`** (`src/backend/services/chat/levels.js`):
- Валидация входных параметров
- Защита от переполнения (максимальное значение SQLite INTEGER)
- Очередь операций для каждого пользователя (предотвращение race conditions)
- Транзакции для атомарности операций
- Автоматическая инициализация уровня для новых пользователей
- Эмиссия событий при повышении уровня и добавлении опыта

**События**:
- `level:up` — пользователь повысил уровень
- `level:exp:added` — пользователю добавлен опыт

## Система наград

### Обработка Channel Points Redemptions

**EventSub Integration** (`src/backend/services/twitch/eventsub.js`):
- Подписка на события активации наград
- Валидация подписи веб-хука через HMAC-SHA256
- Парсинг данных награды

**Обработка наград**:
1. **Валидация**:
   - Проверка наличия обязательных полей
   - Фильтрация нецензурной лексики для наград с пользовательским вводом
   - Отклонение наград с недопустимым содержимым

2. **Сохранение в БД**:
   - Обновление таблицы `rewards` (статистика использования)
   - Вставка записи в `redemptions` (история активаций)
   - Связь с пользователем через `user_stats`

3. **Начисление опыта**:
   - Автоматическое начисление опыта равного стоимости награды
   - Логирование операции

4. **Специальные награды**:
   - **User Info** — отображение информации о пользователе (алерт)
   - **Shoutout** — выкрик пользователя с сообщением (алерт)

### База данных наград

**Таблица `rewards`**:
- `reward_id` — уникальный ID награды
- `title` — название награды
- `cost` — стоимость в баллах
- `enabled` — включена ли награда
- `prompt` — текст подсказки для пользователя
- `redemption_count` — количество активаций

**Таблица `redemptions`**:
- `redemption_id` — уникальный ID активации
- `reward_id` — ссылка на награду
- `username` — пользователь, активировавший награду
- `cost` — стоимость на момент активации
- `status` — статус (unfulfilled, fulfilled, cancelled)
- `user_input` — пользовательский ввод (если требуется)
- `redeemed_at` — время активации
- `fulfilled_at` — время выполнения

## Система бонусов

### First Message Bonus

**FirstMessageBonusService** (`src/backend/services/bonuses/FirstMessageBonusService.js`):
- Отслеживание пользователей, получивших бонус за первое сообщение
- Проверка статуса стрима (бонус начисляется только во время стрима)
- Автоматический сброс при начале нового стрима
- Защита от повторного начисления

**FirstMessageBonusHandler** (`src/backend/services/bonuses/FirstMessageBonusHandler.js`):
- Подписка на события сообщений
- Проверка первого сообщения пользователя за всё время
- Вызов сервиса для начисления бонуса

## База данных

### Схема

**Таблица `messages`**:
- Хранит все сообщения из чата
- Индексы по username, timestamp, channel
- Флаг `is_command` для фильтрации команд

**Таблица `user_stats`**:
- Статистика пользователей
- Количество сообщений, символов
- Любимые слова (JSON)
- Даты первого и последнего появления

**Таблица `user_levels`**:
- Текущий уровень пользователя
- Опыт в рамках уровня
- Опыт до следующего уровня
- Общий накопленный опыт

**Таблица `rewards`**:
- Информация о наградах Channel Points
- Статистика использования

**Таблица `redemptions`**:
- История активаций наград
- Связь с пользователями и наградами

### Индексы

Оптимизированные индексы для быстрого поиска:
- По username и timestamp (сообщения)
- По уровню и опыту (топы пользователей)
- По статусу и времени активации (награды)

## Фронтенд

### Технологии

- **Vue 3** с Composition API
- **TypeScript** для типизации
- **Tailwind CSS** для стилизации
- **Vite** для сборки
- **Vue Router** для навигации
- **Socket.IO Client** для реал-тайм коммуникации

### Виджеты

#### PDA Widget (`src/frontend/widgets/pda/`)
- Интерактивный виджет КПК (карманного персонального компьютера)
- Управление через Socket.IO события (`togglePDA`, `navigate`)
- Анимации открытия/закрытия
- 3D эффекты наклона при навигации
- Звуковые эффекты (открытие, закрытие, клики клавиатуры)
- Настраиваемые размеры экрана

#### OS Interface Widget (`src/frontend/widgets/os-interface/`)
- Интерфейс операционной системы внутри PDA
- Навигация между разделами

### Страницы

#### Chat (`src/frontend/pages/chat/`)
- Отображение сообщений чата в реальном времени
- Фильтрация команд
- Отображение уровня пользователя
- Индикация подписчиков
- Анимации появления/исчезновения сообщений
- Ограничение количества отображаемых сообщений (по умолчанию 100)

#### Alerts (`src/frontend/pages/alerts/`)
- **User Info Alerts** — информация о пользователе (верх экрана)
  - Уровень, количество сообщений, дата первого появления
  - Потраченные баллы, ранг, любимые слова
- **Shoutout Alerts** — выкрики пользователей (низ экрана)
  - Имя пользователя и сообщение
  - Анимации появления/исчезновения
  - Прогресс-бар с таймером

#### PDA (`src/frontend/pages/pda/`)
- Главная страница с PDA виджетом
- Содержит OS Interface внутри экрана PDA

#### Exp Logger (`src/frontend/pages/exp-logger/`)
- Логирование начисления опыта
- Отображение событий повышения уровня

#### Debug (`src/frontend/pages/debug/`)
- Отладочная информация
- Состояние подключений
- События системы

#### Viewers Count (`src/frontend/pages/viewers-count/`)
- Отображение количества зрителей
- Обновление в реальном времени

### Компоненты

#### ChatMessage (`src/frontend/shared/components/ChatMessage.vue`)
- Отображение одного сообщения чата
- Цветовая индикация уровня
- Отображение эмодзи
- Индикация подписчиков
- Бейджи для первого сообщения

#### AlertCard (`src/frontend/shared/components/AlertCard.vue`)
- Карточка алерта с информацией о пользователе
- Анимации появления/исчезновения
- Прогресс-бар с таймером

#### ShoutoutAlert (`src/frontend/shared/components/ShoutoutAlert.vue`)
- Специальный алерт для выкриков
- Уникальный дизайн и анимации

### Composables

#### useChat (`src/frontend/shared/composables/useChat.ts`)
- Управление состоянием сообщений чата
- Добавление, обновление, удаление сообщений
- Ограничение количества сообщений
- Очистка при размонтировании

#### useAlerts (`src/frontend/shared/composables/useAlerts.ts`)
- Управление алертами
- Таймеры и прогресс-бары
- Автоматическое удаление по истечении времени

#### useSocketConnection (`src/frontend/shared/composables/useSocketConnection.ts`)
- Подключение к Socket.IO
- Обработка событий с валидацией
- Управление состоянием подключения

#### useExpLogger (`src/frontend/shared/composables/useExpLogger.ts`)
- Логирование событий опыта
- Отображение уведомлений о повышении уровня

## Socket.IO События

### От Backend к Frontend

- `chat:message` — новое сообщение в чате
- `chat:message:enriched` — обновление сообщения (добавление информации о подписке)
- `level:exp:added` — пользователю добавлен опыт
- `level:up` — пользователь повысил уровень
- `alert:user_info` — алерт с информацией о пользователе
- `alert:shoutout` — алерт выкрика
- `stream:viewers:updated` — обновление количества зрителей

### От Frontend к Backend

- `togglePDA` — переключение видимости PDA
- `navigate` — навигация в PDA (up, down, left, right)
- `twitchCommand` — команды из чата (обрабатываются на backend)

## REST API

### Chat API (`/api/chat/`)

- `GET /api/chat/stats/user?username=<username>` — статистика пользователя
- `GET /api/chat/stats/top?limit=<number>` — топ пользователей по сообщениям
- `GET /api/chat/stats/words?username=<username>&limit=<number>` — любимые слова пользователя
- `GET /api/chat/messages/recent?limit=<number>` — последние сообщения
- `GET /api/chat/stats/overview?period=<period>` — общая статистика за период

### Levels API (`/api/levels/`)

- `GET /api/levels/user?username=<username>` — уровень пользователя
- `GET /api/levels/top?limit=<number>` — топ по уровням
- `GET /api/levels/top-exp?limit=<number>` — топ по опыту

### Rewards API (`/api/rewards/`)

- `GET /api/rewards/list` — список всех наград
- `GET /api/rewards/stats?reward_id=<id>` — статистика награды
- `GET /api/rewards/user?username=<username>` — награды пользователя

## Безопасность

### Защита от злоупотреблений

1. **Rate Limiting**:
   - Ограничение частоты сообщений
   - Защита от спама

2. **Валидация данных**:
   - Проверка всех входных данных
   - Фильтрация нецензурной лексики
   - Валидация формата токенов

3. **Защита веб-хуков**:
   - Проверка HMAC-SHA256 подписи от Twitch
   - Валидация источника запросов

4. **Защита от переполнения**:
   - Ограничение максимального значения опыта
   - Валидация числовых значений

## Производительность

### Оптимизации

1. **База данных**:
   - Индексы для быстрого поиска
   - WAL режим для параллельных операций
   - Подготовленные запросы (prepared statements)

2. **Очереди операций**:
   - Последовательная обработка опыта для каждого пользователя
   - Предотвращение race conditions
   - Автоматическая очистка неиспользуемых очередей

3. **Асинхронная обработка**:
   - Неблокирующая отправка сообщений
   - Асинхронное обогащение информацией о подписке
   - Фоновая обработка статистики

4. **Кэширование**:
   - Кэширование уровней пользователей
   - Кэширование информации о подписках

## Логирование

### Уровни логирования

- **INFO** — информационные сообщения
- **SUCCESS** — успешные операции
- **WARNING** — предупреждения
- **ERROR** — ошибки

### Структурированное логирование

- Цветовое форматирование в консоли
- Временные метки
- Контекстная информация
- Секции и разделители для читаемости

## Расширяемость

### Система плагинов

Плагины автоматически загружаются из папки `plugins/`:
- Каждый плагин — отдельная папка с `index.js`
- Доступ к Event Bus и Service Manager
- Автоматическая инициализация при запуске

### События для интеграции

Все ключевые события доступны через Event Bus:
- `twitch:irc:message` — сообщения из чата
- `level:up` — повышение уровня
- `level:exp:added` — добавление опыта
- `alert:user_info` — алерты пользователей
- `stream:online` / `stream:offline` — статус стрима
- И многие другие

## Конфигурация

### Переменные окружения (`.env`)

```env
# Twitch
TWITCH_ACCOUNT=your_channel
ACCESS_TOKEN=your_token
CLIENT_ID=your_client_id
SECRET=your_client_secret
REFRESH_TOKEN=your_refresh_token

# Server
PORT=3001

# Debug
DEBUG_EVENTS=false
DEBUG_TWITCH_IRC=false
```

### Константы

- `src/backend/services/bonuses/constants.js` — настройки бонусов
- `src/backend/services/chat/config.js` — настройки чата и уровней

## Скрипты

### Утилиты

- `scripts/viewDatabase.js` — просмотр базы данных
- `scripts/getUserStats.js` — статистика пользователя
- `scripts/list-top-users.js` — топ пользователей
- `scripts/check-favorite-words.js` — проверка любимых слов
- `scripts/update-favorite-words.js` — обновление статистики слов
- `scripts/diagnose-rewards.js` — диагностика наград
- `scripts/diagnose-twitch-irc.js` — диагностика IRC подключения

## Будущие улучшения

См. `TODO.md` для планов развития:
- Анти-абьюз система (диминишинг XP, кулдауны)
- Дополнительные бонусы (ответы другим зрителям, возврат после перерыва)
- Система достижений
- Расширенная аналитика
